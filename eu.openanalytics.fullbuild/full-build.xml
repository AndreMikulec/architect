<project name="eu.openanalytics.architect.full-build" default="all">

	<property file="build.properties" />

	<target name="compile-r" unless="${skip.r.compilation}">
		<ant dir="../eu.openanalytics.r.server.build" inheritall="false">
			<property name="r.version" value="${r.version}"/>
		</ant>
		<delete dir="../eu.openanalytics.architect.r.server.win32.win32/R"/>
		<mkdir dir="../eu.openanalytics.architect.r.server.win32.win32/R"/>
		<copy todir="../eu.openanalytics.architect.r.server.win32.win32/R">
			<fileset dir="${r.output.dir}/${r.version}"/>
		</copy>
		<replaceregexp file="../eu.openanalytics.architect.r.server/about.ini" match="Version: R-(.*)" replace="Version: ${r.version}\\\\n\\\\" />
	</target>
	
	<target name="compile-rj" unless="${skip.rj.compilation}">
		<ant dir="../eu.openanalytics.r.libs.rj.build" inheritall="false">
			<property name="r.version" value="${r.version}"/>
			<property name="rj.version" value="${rj.version}"/>
			<property name="rj.gd.version" value="${rj.gd.version}"/>
		</ant>
		<delete dir="../eu.openanalytics.architect.r.libs.rj.win32.win32/libs"/>
		<mkdir dir="../eu.openanalytics.architect.r.libs.rj.win32.win32/libs"/>
		<copy todir="../eu.openanalytics.architect.r.libs.rj.win32.win32/libs">
			<fileset dir="${rj.output.dir}"/>
		</copy>
		<replaceregexp file="../eu.openanalytics.architect.r.libs.rj/about.ini" match="Version: rj(.*)" replace="Version: rj ${rj.version}; rj.gd ${rj.gd.version}\\\\n\\\\" />
	</target>
		
	<target name="build-r-features">
		<delete dir="${architect.build.dir}"/>
		
		<!-- Workaround: for some reason <property> tags are ignored in the ant calls below. -->
		
		<replaceregexp file="../eu.openanalytics.architect.r.server.build/build.properties" match="forceContextQualifier=(.*)" replace="forceContextQualifier=${forceContextQualifier}" />
		<replaceregexp file="../eu.openanalytics.architect.r.server.build/build.properties" match="statet.repo.path=(.*)" replace="statet.repo.path=${statet.repo.path}" />
		<replaceregexp file="../eu.openanalytics.architect.r.server.build/build.properties" match="baseLocation=(.*)" replace="baseLocation=${baseLocation}" />
		
		<ant dir="../eu.openanalytics.architect.r.server.build" inheritall="false"/>

		<replaceregexp file="../eu.openanalytics.architect.r.libs.rj.build/build.properties" match="forceContextQualifier=(.*)" replace="forceContextQualifier=${forceContextQualifier}" />
		<replaceregexp file="../eu.openanalytics.architect.r.libs.rj.build/build.properties" match="statet.repo.path=(.*)" replace="statet.repo.path=${statet.repo.path}" />
		<replaceregexp file="../eu.openanalytics.architect.r.libs.rj.build/build.properties" match="baseLocation=(.*)" replace="baseLocation=${baseLocation}" />
		
		<ant dir="../eu.openanalytics.architect.r.libs.rj.build" inheritall="false"/>
	</target>
	
	<target name="build-architect">
		<replaceregexp file="../eu.openanalytics.architect.build/build.properties" match="forceContextQualifier=(.*)" replace="forceContextQualifier=${forceContextQualifier}" />
		<replaceregexp file="../eu.openanalytics.architect.build/build.properties" match="statet.repo.path=(.*)" replace="statet.repo.path=${statet.repo.path}" />
		<replaceregexp file="../eu.openanalytics.architect.build/build.properties" match="baseLocation=(.*)" replace="baseLocation=${baseLocation}" />
		
		<ant dir="../eu.openanalytics.architect.build" inheritall="false"/>
	</target>
	
	<target name="make-installers">
		<ant dir="../eu.openanalytics.architect.build" inheritall="false" target="make-installer"/>
	</target>
	
	<target name="full-build">
		<antcall target="compile-r"/>
		<antcall target="compile-rj"/>
		<antcall target="build-r-features"/>
		<antcall target="build-architect"/>
		<antcall target="make-installers"/>
		
		<delete dir="${dist.dir}"/>
		<mkdir dir="${dist.dir}"/>
		<copy todir="${dist.dir}">
			<fileset dir="${architect.build.dir}/deploy">
				<include name="*.exe"/>
				<include name="*.zip"/>
			</fileset>
		</copy>
	</target>
	
	<target name="all">
		<antcall target="full-build">
			<param name="dist.dir" value="${dist.dir.stable}" />
			<param name="statet.repo.path" value="${statet.repo.path.stable}" />
		</antcall>
		<antcall target="full-build">
			<param name="dist.dir" value="${dist.dir.testing}" />
			<param name="statet.repo.path" value="${statet.repo.path.testing}" />
		</antcall>
	</target>
</project>